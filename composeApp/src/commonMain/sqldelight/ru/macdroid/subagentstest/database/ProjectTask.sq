-- Team Assistant: Project Task Management Table
-- This table stores tasks for the Team Assistant feature

CREATE TABLE IF NOT EXISTS ProjectTask (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    description TEXT NOT NULL,
    status TEXT NOT NULL,      -- TODO, IN_PROGRESS, DONE
    priority TEXT NOT NULL,    -- LOW, MEDIUM, HIGH, CRITICAL
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    due_date INTEGER,          -- nullable, epoch milliseconds
    completed_at INTEGER       -- nullable, when task was completed
);

-- Indexes for performance optimization
CREATE INDEX IF NOT EXISTS task_status_idx ON ProjectTask(status);
CREATE INDEX IF NOT EXISTS task_priority_idx ON ProjectTask(priority);
CREATE INDEX IF NOT EXISTS task_due_date_idx ON ProjectTask(due_date);
CREATE INDEX IF NOT EXISTS task_status_priority_idx ON ProjectTask(status, priority);

-- Query: Select all tasks sorted by priority (CRITICAL first) then by created_at
selectAll:
SELECT * FROM ProjectTask
ORDER BY
    CASE priority
        WHEN 'CRITICAL' THEN 1
        WHEN 'HIGH' THEN 2
        WHEN 'MEDIUM' THEN 3
        WHEN 'LOW' THEN 4
    END,
    created_at DESC;

-- Query: Select task by ID
selectById:
SELECT * FROM ProjectTask WHERE id = :id;

-- Query: Select tasks by status
selectByStatus:
SELECT * FROM ProjectTask
WHERE status = :status
ORDER BY
    CASE priority
        WHEN 'CRITICAL' THEN 1
        WHEN 'HIGH' THEN 2
        WHEN 'MEDIUM' THEN 3
        WHEN 'LOW' THEN 4
    END,
    created_at DESC;

-- Query: Select tasks by priority
selectByPriority:
SELECT * FROM ProjectTask
WHERE priority = :priority
ORDER BY created_at DESC;

-- Query: Select overdue tasks (not done + past due date)
selectOverdueTasks:
SELECT * FROM ProjectTask
WHERE status != 'DONE'
AND due_date IS NOT NULL
AND due_date < :currentTime
ORDER BY due_date ASC;

-- Query: Select upcoming tasks (within a time range)
selectUpcomingTasks:
SELECT * FROM ProjectTask
WHERE status != 'DONE'
AND due_date IS NOT NULL
AND due_date >= :currentTime
AND due_date <= :endTime
ORDER BY due_date ASC;

-- Query: Search tasks by title or description
searchTasks:
SELECT * FROM ProjectTask
WHERE (LOWER(title) LIKE '%' || LOWER(:query) || '%'
    OR LOWER(description) LIKE '%' || LOWER(:query) || '%')
ORDER BY updated_at DESC;

-- Mutation: Insert new task
insert:
INSERT INTO ProjectTask(title, description, status, priority, created_at, updated_at, due_date, completed_at)
VALUES (?, ?, ?, ?, ?, ?, ?, ?);

-- Mutation: Update task
update:
UPDATE ProjectTask
SET title = :title,
    description = :description,
    status = :status,
    priority = :priority,
    updated_at = :updatedAt,
    due_date = :dueDate,
    completed_at = :completedAt
WHERE id = :id;

-- Mutation: Update only status (lightweight update)
updateStatus:
UPDATE ProjectTask
SET status = :status,
    updated_at = :updatedAt,
    completed_at = :completedAt
WHERE id = :id;

-- Mutation: Delete task by ID
deleteById:
DELETE FROM ProjectTask WHERE id = :id;

-- Statistics: Count tasks by status
countByStatus:
SELECT status, COUNT(*)
FROM ProjectTask
GROUP BY status;

-- Statistics: Count tasks by priority (only non-done tasks)
countByPriority:
SELECT priority, COUNT(*)
FROM ProjectTask
WHERE status != 'DONE'
GROUP BY priority;

-- Statistics: Count overdue tasks
countOverdue:
SELECT COUNT(*) FROM ProjectTask
WHERE status != 'DONE'
AND due_date IS NOT NULL
AND due_date < :currentTime;

-- Utility: Get last inserted row ID
lastInsertRowId:
SELECT last_insert_rowid();
