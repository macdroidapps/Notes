name: üîç AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'composeApp/**/*.kt'
      - 'composeApp/**/*.kts'
      - '**/*.gradle.kts'
      - 'gradle/libs.versions.toml'

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-code-review:
    name: Claude AI Code Review
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: üì• Checkout base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: üîç Get changed files
        id: changed-files
        run: |
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
          git diff --name-only origin/${{ github.event.pull_request.base.ref }}..HEAD > changed_files.txt
          
          # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ Kotlin —Ñ–∞–π–ª—ã
          grep -E '\.(kt|kts)$' changed_files.txt > kotlin_files.txt || true
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ñ–∞–π–ª—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
          if [ ! -s kotlin_files.txt ]; then
            echo "has_kotlin_files=false" >> $GITHUB_OUTPUT
            echo "No Kotlin files changed"
          else
            echo "has_kotlin_files=true" >> $GITHUB_OUTPUT
            echo "Changed Kotlin files:"
            cat kotlin_files.txt
          fi

      - name: üìÑ Generate diff and context
        if: steps.changed-files.outputs.has_kotlin_files == 'true'
        id: generate-context
        run: |
          # –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
          mkdir -p review-artifacts
          
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º diff
          git diff origin/${{ github.event.pull_request.base.ref }}..HEAD > review-artifacts/changes.diff
          
          # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "=== FILE: $file ===" >> review-artifacts/file_contents.txt
              cat "$file" >> review-artifacts/file_contents.txt
              echo -e "\n\n" >> review-artifacts/file_contents.txt
            fi
          done < kotlin_files.txt
          
          # –ö–æ–ø–∏—Ä—É–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø—Ä–æ–µ–∫—Ç–∞
          if [ -d ".claude" ]; then
            cp -r .claude review-artifacts/
          fi
          
          # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ PR
          echo "PR Title: ${{ github.event.pull_request.title }}" > review-artifacts/pr_info.txt
          echo "PR Description: ${{ github.event.pull_request.body }}" >> review-artifacts/pr_info.txt
          echo "Author: ${{ github.event.pull_request.user.login }}" >> review-artifacts/pr_info.txt
          echo "Base Branch: ${{ github.event.pull_request.base.ref }}" >> review-artifacts/pr_info.txt

      - name: ü§ñ Run Claude AI Review
        if: steps.changed-files.outputs.has_kotlin_files == 'true'
        id: ai-review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
        run: |
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          pip install anthropic requests

          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç AI review
          python .github/scripts/ai_code_review.py \
            --diff-file review-artifacts/changes.diff \
            --files-file review-artifacts/file_contents.txt \
            --pr-info-file review-artifacts/pr_info.txt \
            --docs-dir review-artifacts/.claude \
            --output-file review-artifacts/review.md

      - name: üí¨ Post review comment
        if: steps.changed-files.outputs.has_kotlin_files == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const reviewContent = fs.readFileSync('review-artifacts/review.md', 'utf8');
            
            // –ò—â–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç –±–æ—Ç–∞
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('üîç Code Review Summary')
            );
            
            const commentBody = `${reviewContent}
            
            ---
            <sub>ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π review –æ—Ç Claude AI ‚Ä¢ [Powered by Anthropic](https://www.anthropic.com/)</sub>`;
            
            if (botComment) {
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

      - name: üìä Upload review artifacts
        if: always() && steps.changed-files.outputs.has_kotlin_files == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: code-review-artifacts
          path: review-artifacts/
          retention-days: 30

      - name: ‚úÖ Skip review (no Kotlin files)
        if: steps.changed-files.outputs.has_kotlin_files == 'false'
        run: |
          echo "‚úÖ No Kotlin files changed, skipping AI review"

